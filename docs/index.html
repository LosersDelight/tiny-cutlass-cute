<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description"
        content="Tiny Cutlass Cute: from tiling to layout algebra a hacker's delight">
  <meta name="keywords" content="cutlass, cute, cuda">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tiny Cutlass Cute: from tiling to layout algebra a hacker's delight</title>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-PYVRSFMDRL"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'G-PYVRSFMDRL');
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const codeBlocks = document.querySelectorAll('pre > code');
      
      codeBlocks.forEach(block => {
        const pre = block.parentElement;
        const container = document.createElement('div');
        container.className = 'code-container';
        
        pre.parentNode.replaceChild(container, pre);
        
        const shadow = container.attachShadow({ mode: 'open' });
        
        const styleLink = document.createElement('link');
        styleLink.rel = 'stylesheet';
        styleLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css';
        shadow.appendChild(styleLink);
        
        shadow.appendChild(pre);
        
        Prism.highlightElement(block);
      });
    });
  </script>

  <!-- hilight -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-clike.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>

  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="./static/css/bulma.min.css">
  <link rel="stylesheet" href="./static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="./static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="./static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="./static/css/index.css">
  <link rel="icon" href="./static/images/favicon.svg">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="./static/js/fontawesome.all.min.js"></script>
  <script src="./static/js/bulma-carousel.min.js"></script>
  <script src="./static/js/bulma-slider.min.js"></script>
  <script src="./static/js/index.js"></script>
</head>
<body>

<nav class="navbar" role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </a>
  </div>
  <div class="navbar-menu">
    <div class="navbar-start" style="flex-grow: 1; justify-content: center;">
      <a class="navbar-item" href="https://github.com/66RING">
      <span class="icon">
          <i class="fas fa-home"></i>
      </span>
      </a>

      <div class="navbar-item has-dropdown is-hoverable">
        <a class="navbar-link">
          More Research
        </a>
        <div class="navbar-dropdown">
          <a class="navbar-item" href="">
            Nothing
          </a>
        </div>
      </div>
    </div>

  </div>
</nav>


<section class="hero">
  <div class="hero-body">
    <div class="container is-max-desktop">
      <div class="columns is-centered">
        <div class="column has-text-centered">
          <h1 class="title is-1 publication-title">
            Tiny Cutlass Cute: from tiling to layout algebra a hacker's delight
          </h1>
          <div class="is-size-5 publication-authors">
            <span class="author-block">
              <a href="https://github.com/66RING">66RING</a>
            </span>
          </div>

          <div class="is-size-5 publication-authors">
            <span class="author-block">The Loser Master</span>
          </div>

        </div>
      </div>
    </div>
  </div>
</section>

<section class="hero teaser">
  <div class="container is-max-desktop">
    <div class="hero-body">
      <img id="teaser" src="./static/assets/image/cutlass_logo.png" height="100%"/>
    </div>
  </div>
</section>


<section class="section">
  <div class="container is-max-desktop">
    <!-- SS1. -->
    <div class="columns is-centered has-text-centered">
      <div class="column is-four-fifths">
        <h2 class="title is-2">A Simple Single-level tiling</h2>
        <div class="content has-text-justified">
          <p>
          It start with a simple copy.
          </p>

          <p>
          Let say copy from <strong>src</strong> to <strong>dst</strong>. A simple <strong>fully copy without any slicing</strong>.
          </p>

          <pre><code class="language-c">
// src: [0, 1, 2, 3]
// dst: [0, 1, 2, 3]
for (int i = 0; i < dst.size(); i++) {
  dst[i] = src[i];
}
          </code></pre>


          <p>
          A more complicate <strong>2D fully copy</strong> look like this.
          </p>

          <pre><code class="language-c">
// shape = (2, 4)
// src: [
//   [0, 1, 2, 3]
//   [4, 5, 6, 7]
// ]
//
// shape = (2, 4)
// dst: [
//   [0, 1, 2, 3]
//   [4, 5, 6, 7]
// ]
for (int i = 0; i < dst.size(); i++) {
  dst[i] = src[i];
}
          </code></pre>

          <p>
          Or we can use a <strong>coordinate</strong> manner.
          </p>

          <pre><code class="language-c">
// shape = (2, 4)
// src: [
//   [0, 1, 2, 3]
//   [4, 5, 6, 7]
// ]
//
// shape = (2, 4)
// dst: [
//   [0, 1, 2, 3]
//   [4, 5, 6, 7]
// ]
for (int r = 0; r < dst.size<0>(); r++) {
  for (int c = 0; c < dst.size<1>(); c++) {
    dst[r][c] = src[r][c];
  }
}
          </code></pre>

          <p>
          Things become more complicate if we want to copy a <strong>slice</strong>. And now the stride of the underlying <strong>physical layout</strong> works.

          <br/>
          1. Firstly we want to copy a slice of shape(2, 2)
          <br/>
          2. The physical layout is (2, 4)
          <br/>
          3. Taking stride carefully
          </p>

          <pre><code class="language-c">
// shape = (2, 4)
// src: [
//   [0, 1, 2, 3]
//   [4, 5, 6, 7]
// ]
//
// shape = (2, 4)
// dst: [
//   [0, 1, 2, 3]
//   [4, 5, 6, 7]
// ]
//
// NOTE: we want to copy a slice:
// [
//   [0, 1]
//   [4, 5]
// ]
auto phy_shape = {2, 4};
auto phy_stride = {4, 1};
for (int r = 0; r < dst.size<0>(); r++) {
  for (int c = 0; c < dst.size<1>(); c++) {
    // coordinate to index: idx = crd2idx(m, n)
    auto i = r * phy_stride[0] + c * phy_stride[1];
    dst[i] = src[i];
  }
}
          </code></pre>

          <p>
          What if the slice start with a offset? Let say the [2, 3, 6, 7].
          <br/>
          The stride still work.
          </p>

          <pre><code class="language-c">
// shape = (2, 4)
// src: [
//   [0, 1, 2, 3]
//   [4, 5, 6, 7]
// ]
//
// shape = (2, 4)
// dst: [
//   [0, 1, 2, 3]
//   [4, 5, 6, 7]
// ]
//
// NOTE: we want to copy a slice:
// [
//   [2, 3]
//   [6, 7]
// ]
//
// NOTE: The stride still work as 4!
// [
//   [offset]
//   [2, 3, x, x]
//   [6, 7, ?, ?]
// ]
auto phy_shape = {2, 4};
auto phy_stride = {4, 1};
dst = dst + 2;
src = src + 2;
for (int r = 0; r < dst.size<0>(); r++) {
  for (int c = 0; c < dst.size<1>(); c++) {
    // coordinate to index: idx = crd2idx(m, n)
    auto i = r * phy_stride[0] + c * phy_stride[1];
    dst[i] = src[i];
  }
}
          </code></pre>

          <p><strong>
          A tiling is like create a slice of global memory or share memory. And prepare(copy) data.
          <br>
          - g2g
          <br>
          - g2s
          <br>
          - s2r
          <br>
          - ...
          <br>
          </strong></p>


        </div>
      </div>
    </div>
    <!--/ SS1. -->

    <!-- SS2. -->
    <div class="columns is-centered has-text-centered">
      <div class="column is-four-fifths">
        <h2 class="title is-2">The Multi-level tiling</h2>
        <div class="content has-text-justified">
          <p>
          Think about something like we have a slice of global memory gAgA and a copy of this slice sAsA.
          </p>

          <p>
          The first gA means the "logical layout": a global logical layout of A.
          The second gA means the "physical layout and backend": physical layout of A, backend by global memory.
          </p>

          <p>
          The thing is: 1) We want to copy a slice from global memory to share memory. 2) We want to copy a slice by
          warp group from share memory: the warps layout. 3) We then copy from a slice of warp's layout to thread's registers.
          </p>

          <p>
          And to make things easy. We introduce <strong>Tensor</strong>, a structure who take care of shape, stride, crd2idx
          idx2crd(logical index to logical coordinate), and the base offset(e.g. physical idx + base_offset).
          </p>

          <pre><code class="language-c">
struct Tensor {
  void* data_ptr;
  size_t base_offset_;
  Shape shape_;
  Stride stride_;
  // logical coordinate to **physical** index.
  size_t crd2idx();
  // logical index to **logical** coordinate.
  Coord idx2crd();
};
          </code></pre>

          <p>
          Then the copy looks like this.
          </p>

          <pre><code class="language-c">
// shape = (2, 4)
// global_layout: [
//   [0, 1, 2, 3]
//   [4, 5, 6, 7]
// ]
//
// shape = (2, 2)
// global_local_slice: [
//   [x, x, 2, 3]
//   [x, x, 6, 7]
// ]
//
// shape = (2, 2)
// smem_layout: [
//   [2, 3]
//   [6, 7]
// ]
//
// shape = (1, 2)
// warps_layout: [
//   [2, 3]
// ]
//
// shape = (1, 1)
// threads_layout: [
//   [3]
// ]

// name: gmem layout of A, backend by gmem
// shape:stride = (2, 4):(4, 1)
// base offset = 0
Tensor gA;
// name: local gmem layout of A, backend by gmem
// shape:stride = (2, 2):(4, 1), base
// base offset = xxx
Tensor gAgA;
// name: smem layout of A, backend by smem
// shape:stride = (2, 2):(2, 1)
// base offset = 0
Tensor sAsA;
// name: warps layout of A, backend by smem
// shape:stride = (1, 2):(2, 1)
// base offset = xxx
Tensor wAsA;
// name: threads layout of A, backend by reg
// shape:stride = (1, 1):(1, 1)
// base offset = xxx
Tensor tArA;

// global to shared memory
auto src = gAgA;
auto dst = sAsA;
for (int i = 0; i < dst.size(); i++) {
  // get logical coordinate
  auto l_coord = dst.idx2crd(i);
  // get physical coordinate
  auto src_idx = src.crd2idx(l_coord);
  auto dst_idx = dst.crd2idx(l_coord);
  dst[dst_idx] = src[src_idx];
}

// shared memory to warp tile
auto src = sAsA;
auto dst = wAsA;
for (int i = 0; i < dst.size(); i++) {
  // get logical coordinate
  auto l_coord = dst.idx2crd(i);
  // get physical coordinate
  auto src_idx = src.crd2idx(l_coord);
  auto dst_idx = dst.crd2idx(l_coord);
  dst[dst_idx] = src[src_idx];
}

// warp tile to thread's reg
auto src = wAsA;
auto dst = tArA;
for (int i = 0; i < dst.size(); i++) {
  // get logical coordinate
  auto l_coord = dst.idx2crd(i);
  // get physical coordinate
  auto src_idx = src.crd2idx(l_coord);
  auto dst_idx = dst.crd2idx(l_coord);
  dst[dst_idx] = src[src_idx];
}
          </code></pre>

          <p>
          Now I am happy to get rid of something like: ptr + base_offset + stride0*a + stride1 * b + ...
          </p>


        </div>
      </div>
    </div>
    <!--/ SS2. -->



          <!-- <pre><code class="language-c"> -->
          <!-- </code></pre> -->


  </div>
</section>



<footer class="footer">
  <div class="container">
    <div class="content has-text-centered">
      <a class="icon-link" href="https://github.com/LosersDelight/tiny-cutlass-cute" class="external-link" disabled>
        <i class="fab fa-github"></i>
      </a>
    </div>
    <div class="columns is-centered">
      <div class="column is-8">
        <div class="content">
          <p>
            This website is licensed under a <a rel="license"
                                                href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
            Commons Attribution-ShareAlike 4.0 International License</a>.
          </p>
          <p>
            This means you are free to borrow the <a
              href="https://github.com/nerfies/nerfies.github.io">source code</a> of this website,
            we just ask that you link back to this page in the footer.
            Please remember to remove the analytics code included in the header of the website which
            you do not want on your website.
          </p>
        </div>
      </div>
    </div>
  </div>
</footer>

</body>
</html>
